--- Журнал разработки ---

Проблемы и решения по мере их возникновения, в виде дневника.


[2009-03-01]
1. Начало работы


[2009-03-05]
1. Список доступных дисков


[2009-03-07]
1. Листание директорий


[2009-03-10]
1. Главный диалог и диалог копирования


[2009-03-14]
1. Выполнение файлов


[2009-03-18]
1. Копирование файлов


[2009-03-19]
1. Проблема: Нужно прекратить реализацию функций, пока у тех
   что реализованы не будут устранены все важные замечания


[2009-03-21]
1. Проблема: Файл после завершения копирования остаётся открытым.
2. Проблема: Нужны две процедуры: "Формировать путь источника",
   "Формировать путь назначения"


[2009-03-23]
1. Сделано: Файл после завершения копирования не остаётся открытым.
2. Сделано: Панель назначения обновляется после копирования файла.
3. Сделано: Диалог копирования появляется, только после 1 с времени копирования,
   чтобы избежать его мелькания при времени копирования менее 1 с


[2009-03-24]
1. Сделано: В диалоге копирования отображается оставшееся время.
2. Скорость копирования вычисляется из количества скопированных байт,
   и времени потраченного на их копирование, т.о. вычесленная скорость копирования
   это средняя скорость копирования за всё потраченное время. Пользователь полагает,
   что отображается текущая скорость. Проблема ?
3. Сделано: Поток копирования создаётся с параметрами по умолчанию,
   т.е. параметры приоритета, и автоматического изменения приоритета,
   оставляются управляемыми системой.


[2009-03-25]
1. Проблема: После выбора диска, поле с выбранным диском, иногда остаётся пустым
2. Проблема: Панель занятая листанием директории, остаётся активной
3. Сделано: L".." есть во всех папках
4. Рефактор: BOOL listDirectoryToPanel (HWND hDlg, UINT panelId, UINT fullPathId);
   было BOOL listDirectoryToPanel (HWND hDlg, UINT panelId, TCHAR* path);
        

[2009-03-29]
1. Сделано: Сохранение текущей папки
2. Изменён формат сохранения элементов диалога
3. Сделано: Панель занятая листанием директории, скрыта, и не активна
4. Сделано: Копирование файлов из левой в правую и из правой в левую панель
5. Сделано: Нет сообщения об ошибке при смене диска, если диск отсутсвует


[2009-05-01]
1. Код из файла fileman.cpp вынесен в несколько *.cpp и *.h файлов
2. Рефакторинг
3. Сделано: [2009-03-21] 2.
4. Сделано: Пути в диалоге "Копирование" теперь выводятся полностью.
5. Сделано: Теперь проект возможно собрать в Visual Studio 6
6. Проблема: Оставшиеся важные замечания для решённых Свойств или Функций:
6.1 Выполнение файлов - Кнопка Enter не задействована
6.2 Двух цветная подсветка фона строк панелей - Не настраивается
6.3 Простой интерфейс - Нет горячих клавиш
6.4 Пропорциональное изменение ширины колонок - Не сохраняется
7. Сделано: Копирование группы файлов
8. Проблема: Нужна процедура обрезки строки справо до заданного символа


[2009-05-03]
1. Проблема: Если при листании директории сменить диск, то после завершения листания
   будет отбражено содержание не той папки, путь которой указан в поле "путь текущей папки"
2. Проблема: Иногда возникает ошибка обращения к памяти после завершения копирования


[2009-05-22]
1. Проблема: Панель не обновляется, если содержание папки было изменено другой программой
2. Проект собирается без опции линковщика /FORCE:MULTIPLY
3. CopyFileData заменён на CopyTask и Progress
4. Решено: [2009-05-03] 2.
5. Вызовы CRT для обработки строк заменены на вызовы kernel32.dll
6. Сделано: [2009-05-01] 8.


[2009-05-30]
1. Решено: Копирование списка из файлов и/или папок с рекурсией
2. Процедура copyFilesRecurse() возвращает правильное значение при успешном завершении


[2009-06-01]
1. Процедура copyFilesRecurse() возвращает правильное значение при успешном завершении, даже
   если одновременно работает несколько потоков копирования, т.к. больше не содержит
   статическую переменную, подщитывающую вложенность


[2009-06-02]
1. Задача: Нужно общие для всех *.h файлов #define-настройки, вынести в отдельный файл


[2009-06-05] 
1. Задача: Процедура copyFilesRecurse() требует оптимизации (см. её граф)


[2009-06-09]
1. Сделано: Панели обновляются при изменении содержимого папок
2. Сделано: [2009-05-01] 6.2


[2009-06-17]
1. Проблема: сообщения от Header Control типа HDN_ENDTRACK и т.п. не приходят
2. Можно задать пропорции для ширины колонок


[2009-06-20]
1. Относительные ширины колонок сохраняются при выходе,
   при изменении размера  окна, возвращаются к тем значениям, которые были загружены
2. Сделано: [2009-06-05] 1.


[2009-06-22]
1. Сделано: [2009-06-20] 1.
2. Навигация по папкам через клавиши стрелок и Enter


[2009-06-24]
1. Индекс колонки, по которой сортируется панель сохраняется
2. Панель сортируется автоматически по заданной колонке, при заполнении


[2009-06-29]
1. Программа не вылетает при прерывании копирования
2. Проблема: Главное окно программы сворачивается, при прерывании копирования


[2009-07-09]
1. Удаление файлов и папок
2. Исправлена процедура lstrrchr, которая работала не правильно, если строка
   имела нулевую длинну


[2009-07-10]   
1. Отображение иконок файлов


[2009-07-13]
1. Улучшения кода
2. Проблема: После копирования, у некоторых файлов,
   устанавливается атрибут "только чтение"


[2009-07-17]
1. Улучшения кода
2. Операция перемещения


[2009-07-18]
1. Улучшения кода - устранены причины предупреждений


[2009-07-22]
1. Контекстное меню проводника для файла


[2009-08-18]
1. Изменён вид главного окна


[2009-09-16]
1. Нужно сделать проверку, если копирование/перемещение
   производится в под-папку источника. Копирование
   папки в свою подпапку будет продолжаться до тех пор, пока система
   не откажет в выполнении этой операции, из за достижения максимального
   уровня вложенности.


[2009-10-04]
1. + Изменены процедуры listDirectoryToPanelWorker
     и addFileToListView. Теперь увеличение lvI.iItem производится в
     listDirectoryToPanelWorker что является более логичным.
2. + Улучшения кода
3. - Проект не собирается в VS6
4.   Файл strings.h удалён из проекта. В файл consts.h перенесены константы
     из других файлов проекта
   

[2009-10-08]
1. + Исправлена ошибка в процедуре addFileToListView. Теперь содержимое
     передаваемых в неё структур не изменяется.
2. + Изменена процедура copySelected. Проверка на служебный символ L".."
     заменила проверку на индекс строки в List View.
3. + Правильное отображение элементов корневой директории.


[2009-10-16]
1. + В выборе диска указываются метка диска и файловая система
2. ? Файлы над которыми не возможно выполнить операцию, тихо пропускаются
3. + Процедура recurseOperation улучшена
4. + Отображение размера диска и свободного места на нём
5. - При выборе пустого диска, возникает ошибка "типа устройство не готово"


[2009-10-24]
1. + Закрывается дескриптор рабочего потока листания директории в панель
2. + Закрывается дескриптор рабочего потока подсчёта размера папки
3. - Число дескрипторов иногда увеличивается
4. + Устранена утечка дескрипторов потоков операций "Листать" и "Подсчёт" [2009-10-24] 3.

[2009-10-26]
1. + Подсчитанный размер папки записывается в структуре WIN32_FIND_DATA,
     указатель на которую хранится в lParam строки ListView в нулевой колонке
2. ? Упрощена процедура анимации выполнения операции подсчёта размера папки


[2009-10-29]
1. + Устранена утечка памяти при листании директорий
2. + Решено [2009-03-25] 1.

[2009-11-05]
1. + Устранена утечка дескрипторов в процедуре GetFileNameFromHandle


[2009-11-06]
1. + Улучшено листание папки в панель (уменьшены время и размер памяти,
     устранены ошибки при работе со строками)

[2009-11-07] 
1. + Устранена ошибка при автоматическом обновлении содержимого папки
2. + Небольшой рефакторинг
3. - Не удаляются файлы, с атрибутом "только чтенние"
4. + Файлы для которых сиситема не находит иконк, помечаются своей иконкой
5. - Для файлов, расположенных на CD приводе не в корневой папке,
     система не находит иконок


[2009-11-09]
1. + Решено [2009-11-07] 5.: Убран флаг SHGFI_USEFILEATTRIBUTES при вызове SHGetFileInfo


[2009-11-10]
1. + Решено [2009-11-07] 3.: При удалении любого файла, атрибут "Только чтение" снимается
2. + Улучшено обновление панели при подсчёте размера: Обновление размера происходит по
     главному таймеру.
3. ? Период главного таймера установлен в 133 мс


[2009-11-11]
1. + Сделано № 12. Отображение суммарного размера выделеных фалйлов и папок
2. X Отменено № 04. Продолжение копирования файлов
3. X Отменено № 35. Настройка по принципу "Как вижу так и есть"


[2009-11-12]
1. + Сделано № 65. Создание папки


[2009-11-18]
1. + Убраны чужие потоки возникающие после первого касания List View.
     Проблема Решена переходом на Common Controls 6.0: добавлен Fileman.exe.manifest
     #define _WIN32_IE (0x0600), #define _WIN32_WINNT	(0x0501), #define WINVER (0x0501)
   

[2009-11-19]
1. + Сортировка панелей по всем колонкам кроме типа, используя WIN32_FIND_DATA


[2009-11-22]
1. + Изменено отображение операции удаления. Отображается
     уровень вложенности и название удалённого файла: вся длинна прогрессбара -
     максимальный уровень вложенности, длина полоски - текущий уровень вложенности
2. + Исправлена ошибка в addFileToListView, возникавшая
     при добавлении файла без расширения. Вместо расширения добавлялась
     не иницилизированная строка, если расширение не было найдено.


[2009-11-26]
1. - Если в панели отображается папка в которой лежит исполняемый файл
     программы, то программа при выходе зависает, входя в deadlock
     

[2009-12-04]
1. + Исправлено отбражение метки диска, если метки диска нет
2. + Решено [2009-06-17] 1: Сабклассинг List View.
3. + Выбор диска не активен во время листания в панель
4. + Решено [2009-06-20] 1.


[2009-12-13]
1. + Drug & Drop

[2010-02-01]
1. + Элемент с полным путём заменён на Combo-box со списком дисков
2. + Интерфейс перечислений по локальному диску
3. + Интерфейс перечислений по аудио диску
4. - Чтение названий треков аудио диска не учитывает структуры названий дорожек
     (один исполнитель или несколько исполнителей)
5. - Не всегда правильно определяется интерфейс: локальный диск путается с
     аудио диском, в следствии чего программа вылетает с ошибкой доступа к памяти

[2010-04-14]
1. - Начат переход от идентификаторов элементов к их дескрипторам, для сокращения кода.
     Работа ведётся с классом LTPD.
2. - Проверить получение сообщения FM_LIST_FINISHED, т.к. второй параметр теперь не
     дескриптор панели, а 0, т.к. дескриптор панели теперь передаётся lParam c класcом LTPD.

[2010-04-22]
1. + Решено [2010-04-14] 2.
2. + Решено [2010-02-01] 5. Увеличен размер буфера в процедуре

[2010-05-18]
1. + Решено [2009-11-26] 1.

[2010-07-22]
1. - Выделение большого количества файлов происходит медленно,
     из за того, что приходит сообщение LVN_ITEMCHANGED для каждого элемента,
     и соотв. вызов onItemChanged.
     
[2010-07-22]
1. + Свойство панелей L"Counted item" перенесено в FmPanelProps::coutedItem


[2010-08-19]
1. - Если в папке есть файл и папка с одинаковыми именами (исключая
     расширение для файла, то вместо открытия файла происходит вход
     в одноимённую директорию


[2010-08-21]
1. + Решено [2010-08-19] 1.
2. + Решена прблема с выделенной строкой панели - индекс выбранной строки панели
     определяемый системой после заполнения панели был равен -1,
     если строка не была кликнута мышью, а выделялась с помощью стрелок
     (см. решение в FmPanelProps::curSel и subClassLvProc).
3. + Улучшения кода
4. + Некоторые свойства панели перенесены из GetProp/SetProp в FmPanelProps.
5. - Пропали цвета в оформлении панелей - не приходят сообщения
     о стадиях прорисовки в процедуру onCustomDrawPanel
     

[2010-08-26]
1. + Решено [2010-08-21] 5.


[2010-08-28]
1. + Сделано № 74. Вызов консоли

[2010-09-03]
1. + Решено [2010-08-21] 5. Теперь на в ответ на сообщение WM_NOTIFY
     возвращается нужный код, а не 0 всегда.
2. + Устранина проблема с выделением строки в панели. Для задания выделеной строки
     в ListView нужно указывать два флага состояния LVIS_SELECTED и LVIS_FOCUSED
     

[2010-09-13]
1. ? Своё Сообщение WM_USER_MEDIACHANGED не приходит. Использованы вызовы
     оболочки SHGetPathFromIDList, SHGetSpecialFolderLocation, SHChangeNotifyRegister.
   
[2010-10-04]
1. - Навигация по папкам находится в нерабочем состоянии, т.к. код переписывается.


[2010-11-29]
1. + Проект теперь использует общую для всех моих проектов библиотеку helper
2. ? Размер стека программы установлен 8000000 байт, т.к. при добавлении 
     объявления TCHAR str [FM_MAX_PATH], программа падала с ошибкой "Переполнение стека"

[2011-01-08]   
1. - Процедуру fillDiskList нужно вызывать по сообщениям WM_USER_MEDIACHANGED и WM_DEVICECHANGE


[2011-01-19]
1. + Решено [2010-10-04] 1.
2. + Есть подозрение на повреждение стека при работе со строками. Об этом намекает
     невозможность найти иконки для некоторых файлов.
   
   
[2011-01-25]
1. + Операции копирование и перемещение реализованы в copy.cpp и copy.h.
     Файлы move.cpp и move.h исключены из проекта.
     
     
[2011-02-22]
1. + При выполнении операции перемещение снимается флаг "только для чтения"


[2011-03-22]
1. - Операции копирования и удаления не выполняются, если программа не запущенна 
     из Visual Studio или параллельно не запущен DbgView


[2011-04-12]
1. + Решено [2011-03-22] 1. Вызов OutputDebugString (через wprintfd) без активного
     дебагера, устанавливает значение GetLastError в FILE_NOT_FOUND. Теперь GetLastError
     вызывается только после возврата значения с ошибкой системным вызовом.


[2011-04-24]
1. + Небольшая оптимизация listDirectoryToPanelWorker


[20011-05-05]
1. + Улучшена навигация. В стеке запоминается индекс выделенной строки
     для каждой директории